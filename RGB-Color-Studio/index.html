<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RGB Color Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{background:#0a0a0f;color:#e0e0e0;font-family:'Rajdhani',sans-serif}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#2a2a3e;border-radius:3px}

/* === MAIN LAYOUT === */
.app{display:flex;height:100vh;overflow:hidden}

/* === LEFT: Canvas area === */
.canvas-area{flex:1;position:relative;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden}
#mainCanvas{display:block;cursor:crosshair}

/* CVD banner on canvas */
.cvd-banner{position:absolute;top:16px;left:50%;transform:translateX(-50%);background:rgba(255,60,60,0.15);backdrop-filter:blur(10px);border:1px solid rgba(255,100,100,0.3);border-radius:20px;padding:6px 20px;font-family:'Space Mono',monospace;font-size:0.75rem;color:#ff9999;text-transform:uppercase;letter-spacing:2px;pointer-events:none;opacity:0;transition:opacity 0.3s;z-index:10;white-space:nowrap}
.cvd-banner.visible{opacity:1}

/* Floating color readout on canvas — big & prominent */
.canvas-overlay{position:absolute;bottom:24px;left:24px;background:rgba(10,10,15,0.9);backdrop-filter:blur(14px);border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:16px;pointer-events:none;display:flex;align-items:center;gap:16px;transition:border-color 0.3s}
.overlay-swatch{width:80px;height:80px;border-radius:10px;border:2px solid rgba(255,255,255,0.2);flex-shrink:0;transition:background 0.1s}
.overlay-info{display:flex;flex-direction:column;gap:2px}
.canvas-overlay .hex-big{font-family:'Space Mono',monospace;font-size:1.8rem;font-weight:700;letter-spacing:1px}
.canvas-overlay .sub-vals{font-family:'Space Mono',monospace;font-size:0.75rem;color:#888;line-height:1.8}
.canvas-overlay .color-name{font-family:'Rajdhani',sans-serif;font-size:0.85rem;color:#aaa;text-transform:uppercase;letter-spacing:1.5px}

/* === RIGHT: Sidebar === */
.sidebar{width:320px;min-width:320px;background:linear-gradient(180deg,#0d0d18,#0a0a12);border-left:1px solid #1a1a2e;display:flex;flex-direction:column;overflow-y:auto;overflow-x:hidden}

.sidebar-section{padding:16px 20px;border-bottom:1px solid #141425}
.sidebar-section:last-child{border-bottom:none}

.section-title{font-family:'Rajdhani',sans-serif;font-weight:600;font-size:0.8rem;text-transform:uppercase;letter-spacing:2.5px;color:#556;margin-bottom:12px}

/* Selected Color display */
.selected-color-preview{width:100%;height:48px;border-radius:8px;border:2px solid rgba(255,255,255,0.18);margin-bottom:12px;transition:background 0.15s;position:relative;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.06)}
.selected-color-bright{width:100%;height:20px;border-radius:0 0 6px 6px;position:absolute;bottom:0;left:0;right:0;opacity:0.6;border-top:1px solid rgba(255,255,255,0.1)}
.color-info-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.color-info-row .label{font-family:'Space Mono',monospace;font-size:0.75rem;color:#556}
.color-info-row .value{font-family:'Space Mono',monospace;font-size:0.75rem;color:#ccc}
.hex-display{font-family:'Space Mono',monospace;font-size:1.1rem;font-weight:700;color:#eee;text-align:center;padding:6px 0;background:rgba(255,255,255,0.03);border-radius:6px;margin-top:8px;cursor:pointer;border:1px solid #1a1a2e;transition:border-color 0.3s}
.hex-display:hover{border-color:#444}

/* Primary buttons */
.primary-btns{display:flex;gap:10px;margin-bottom:8px}
.primary-btn{flex:1;height:42px;border-radius:8px;border:2px solid transparent;cursor:pointer;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:1rem;letter-spacing:1px;transition:all 0.3s;opacity:0.35}
.primary-btn.active{opacity:1;box-shadow:0 0 20px rgba(255,255,255,0.1)}
.primary-btn.r-btn{background:#cc2222;color:#fff}
.primary-btn.r-btn.active{border-color:#ff6666;box-shadow:0 0 20px rgba(255,50,50,0.3)}
.primary-btn.g-btn{background:#22aa22;color:#fff}
.primary-btn.g-btn.active{border-color:#66ff66;box-shadow:0 0 20px rgba(50,255,50,0.3)}
.primary-btn.b-btn{background:#2244cc;color:#fff}
.primary-btn.b-btn.active{border-color:#6688ff;box-shadow:0 0 20px rgba(50,80,255,0.3)}
.primary-hint{font-family:'Space Mono',monospace;font-size:0.65rem;color:#445;text-align:center;margin-top:4px}

/* Sliders */
.slider-group{display:flex;flex-direction:column;gap:10px}
.slider-row{display:flex;align-items:center;gap:10px}
.slider-row .label{font-family:'Space Mono',monospace;font-size:0.75rem;width:50px;font-weight:400}
.slider-row .label.r-c{color:#ff5555}
.slider-row .label.g-c{color:#55ff55}
.slider-row .label.b-c{color:#5588ff}
.slider-row input[type=range]{flex:1;-webkit-appearance:none;height:4px;border-radius:2px;outline:none;cursor:pointer;background:#1a1a2e}
.slider-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;cursor:pointer;border:2px solid rgba(255,255,255,0.5)}
input.r-s::-webkit-slider-thumb{background:#ff4444}
input.g-s::-webkit-slider-thumb{background:#44ff44}
input.b-s::-webkit-slider-thumb{background:#4488ff}
.slider-row .val{font-family:'Space Mono',monospace;font-size:0.75rem;width:28px;text-align:right;color:#888}

/* Color Recipe */
.recipe-box{background:rgba(255,255,255,0.02);border:1px solid #1a1a2e;border-radius:8px;padding:12px;font-family:'Space Mono',monospace;font-size:0.7rem;line-height:1.7;color:#999}
.recipe-box .recipe-line{color:#bbb}

/* Animation Modes */
.mode-btns{display:flex;gap:6px}
.mode-btn{flex:1;font-family:'Rajdhani',sans-serif;font-weight:600;font-size:0.7rem;padding:6px 0;border:1px solid #1e1e30;border-radius:6px;background:transparent;color:#556;cursor:pointer;text-transform:uppercase;letter-spacing:1px;transition:all 0.3s;text-align:center}
.mode-btn:hover{border-color:#444;color:#999}
.mode-btn.active{border-color:#667;color:#ddd;background:rgba(255,255,255,0.04)}

/* Palette Section */
.palette-base-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.palette-base-row input[type=color]{width:34px;height:28px;border:none;border-radius:5px;cursor:pointer;background:none;padding:0}
.use-mixer-btn{font-family:'Rajdhani',sans-serif;font-weight:600;font-size:0.7rem;padding:4px 12px;border:1px solid #1e1e30;border-radius:16px;background:transparent;color:#778;cursor:pointer;transition:all 0.3s;white-space:nowrap}
.use-mixer-btn:hover{border-color:#555;color:#ccc}

.harmony-tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px}
.harmony-tab{font-family:'Rajdhani',sans-serif;font-weight:500;font-size:0.65rem;padding:3px 8px;border:1px solid #1a1a28;border-radius:12px;background:transparent;color:#556;cursor:pointer;transition:all 0.3s;text-transform:uppercase;letter-spacing:0.5px}
.harmony-tab:hover{border-color:#444;color:#999}
.harmony-tab.active{border-color:#778;color:#eee;background:rgba(255,255,255,0.04)}

.wheel-wrap{display:flex;justify-content:center;margin-bottom:10px}
#hslWheel{width:100px;height:100px}

.swatches{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.swatch-card{background:rgba(255,255,255,0.02);border:1px solid #1a1a28;border-radius:6px;padding:8px;cursor:pointer;transition:all 0.3s;text-align:center}
.swatch-card:hover{border-color:#444;transform:translateY(-1px)}
.swatch-color{width:100%;height:36px;border-radius:4px;margin-bottom:5px;border:1px solid rgba(255,255,255,0.04)}
.swatch-role{font-family:'Rajdhani',sans-serif;font-size:0.6rem;color:#667;text-transform:uppercase;letter-spacing:0.5px}
.swatch-hex{font-family:'Space Mono',monospace;font-size:0.7rem;color:#bbb;margin-top:1px}
.swatch-rgb{font-family:'Space Mono',monospace;font-size:0.6rem;color:#556;margin-top:1px}

/* CVD Section — toggle buttons */
.cvd-btns{display:flex;flex-direction:column;gap:5px}
.cvd-btn{display:flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid #1a1a28;border-radius:8px;background:transparent;color:#778;cursor:pointer;transition:all 0.3s;text-align:left}
.cvd-btn:hover{border-color:#444;color:#bbb}
.cvd-btn.active{border-color:#668;color:#fff;background:rgba(255,255,255,0.05);box-shadow:0 0 12px rgba(100,130,255,0.1)}
.cvd-btn .cvd-dot{width:18px;height:18px;border-radius:50%;border:1.5px solid rgba(255,255,255,0.15);flex-shrink:0}
.cvd-btn.active .cvd-dot{border-color:rgba(255,255,255,0.4);box-shadow:0 0 6px rgba(255,255,255,0.15)}
.cvd-btn .cvd-name{font-family:'Rajdhani',sans-serif;font-weight:600;font-size:0.75rem;text-transform:uppercase;letter-spacing:1px}
.cvd-btn .cvd-desc{font-family:'Space Mono',monospace;font-size:0.6rem;color:#556}
.cvd-active-label{font-family:'Space Mono',monospace;font-size:0.65rem;color:#889;text-align:center;margin-top:6px;min-height:1em}

/* Toast */
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(80px);font-family:'Space Mono',monospace;font-size:0.8rem;padding:8px 20px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.15);border-radius:20px;color:#fff;transition:transform 0.4s ease;pointer-events:none;z-index:100}
.toast.show{transform:translateX(-50%) translateY(0)}

/* Responsive */
@media(max-width:800px){
  .app{flex-direction:column}
  .canvas-area{height:55vh;flex:none}
  .sidebar{width:100%;min-width:100%;max-height:45vh}
}
</style>
</head>
<body>

<div class="app">
  <!-- LEFT: Big canvas visualization -->
  <div class="canvas-area">
    <canvas id="mainCanvas"></canvas>
    <div class="cvd-banner" id="cvdBanner"></div>
    <div class="canvas-overlay">
      <div class="overlay-swatch" id="overlaySwatch"></div>
      <div class="overlay-info">
        <div class="hex-big" id="overlayHex">#FF6450</div>
        <div class="color-name" id="overlayName">Orange-Red</div>
        <div class="sub-vals">
          RGB: <span id="overlayRgb">255, 100, 80</span><br>
          HSL: <span id="overlayHsl">7, 100%, 66%</span>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT: Sidebar controls -->
  <div class="sidebar">

    <!-- Selected Color -->
    <div class="sidebar-section">
      <div class="section-title">Selected Color</div>
      <div class="selected-color-preview" id="selPreview"><div class="selected-color-bright" id="selBright"></div></div>
      <div class="color-info-row"><span class="label">R:</span><span class="value" id="infoR">255</span></div>
      <div class="color-info-row"><span class="label">G:</span><span class="value" id="infoG">100</span></div>
      <div class="color-info-row"><span class="label">B:</span><span class="value" id="infoB">80</span></div>
      <div class="hex-display" id="hexCopy">#FF6450</div>
    </div>

    <!-- Select Primaries -->
    <div class="sidebar-section">
      <div class="section-title">Select 2 Primaries</div>
      <div class="primary-btns">
        <button class="primary-btn r-btn active" data-primary="r">R</button>
        <button class="primary-btn g-btn active" data-primary="g">G</button>
        <button class="primary-btn b-btn" data-primary="b">B</button>
      </div>
      <div class="primary-hint">Click two primaries to begin mixing</div>
    </div>

    <!-- Mix Your Own Color -->
    <div class="sidebar-section">
      <div class="section-title">Mix Your Own Color</div>
      <div class="slider-group">
        <div class="slider-row">
          <span class="label r-c">Red</span>
          <input type="range" class="r-s" id="rSlider" min="0" max="255" value="255">
          <span class="val" id="rVal">255</span>
        </div>
        <div class="slider-row">
          <span class="label g-c">Green</span>
          <input type="range" class="g-s" id="gSlider" min="0" max="255" value="100">
          <span class="val" id="gVal">100</span>
        </div>
        <div class="slider-row">
          <span class="label b-c">Blue</span>
          <input type="range" class="b-s" id="bSlider" min="0" max="255" value="80">
          <span class="val" id="bVal">80</span>
        </div>
      </div>
    </div>

    <!-- Color Vision Simulator — moved up for visibility -->
    <div class="sidebar-section">
      <div class="section-title">Color Vision Simulator</div>
      <div class="cvd-btns" id="cvdBtns">
        <button class="cvd-btn active" data-cvd="normal"><div class="cvd-dot" id="cvdDotNormal"></div><div><div class="cvd-name">Normal</div><div class="cvd-desc">Full color vision</div></div></button>
        <button class="cvd-btn" data-cvd="protanopia"><div class="cvd-dot" id="cvdDotProt"></div><div><div class="cvd-name">Protanopia</div><div class="cvd-desc">Red-blind (no L-cones)</div></div></button>
        <button class="cvd-btn" data-cvd="deuteranopia"><div class="cvd-dot" id="cvdDotDeut"></div><div><div class="cvd-name">Deuteranopia</div><div class="cvd-desc">Green-blind (no M-cones)</div></div></button>
        <button class="cvd-btn" data-cvd="tritanopia"><div class="cvd-dot" id="cvdDotTrit"></div><div><div class="cvd-name">Tritanopia</div><div class="cvd-desc">Blue-blind (no S-cones)</div></div></button>
        <button class="cvd-btn" data-cvd="achromatopsia"><div class="cvd-dot" id="cvdDotAchro"></div><div><div class="cvd-name">Achromatopsia</div><div class="cvd-desc">Full color blindness</div></div></button>
      </div>
      <div class="cvd-active-label" id="cvdLabel">Viewing: Normal vision</div>
    </div>

    <!-- Color Recipe -->
    <div class="sidebar-section">
      <div class="section-title">Color Recipe</div>
      <div class="recipe-box" id="recipeBox">
        <div class="recipe-line">Lots of red + a little green</div>
        &rarr; Warm orange-red
      </div>
    </div>

    <!-- Animation Modes -->
    <div class="sidebar-section">
      <div class="section-title">Animation</div>
      <div class="mode-btns">
        <button class="mode-btn active" data-mode="animate">Animate</button>
        <button class="mode-btn" data-mode="particles">Particles</button>
        <button class="mode-btn" data-mode="beams">Beams</button>
      </div>
    </div>

    <!-- Palette Generator -->
    <div class="sidebar-section">
      <div class="section-title">Palette Generator</div>
      <div class="palette-base-row">
        <input type="color" id="basePicker" value="#ff6450">
        <button class="use-mixer-btn" id="useMixerBtn">&larr; Use Mixer</button>
      </div>
      <div class="harmony-tabs" id="harmonyTabs">
        <button class="harmony-tab active" data-harmony="complementary">Complement</button>
        <button class="harmony-tab" data-harmony="analogous">Analogous</button>
        <button class="harmony-tab" data-harmony="triadic">Triadic</button>
        <button class="harmony-tab" data-harmony="split">Split</button>
        <button class="harmony-tab" data-harmony="tetradic">Tetradic</button>
        <button class="harmony-tab" data-harmony="monochromatic">Mono</button>
      </div>
      <div class="wheel-wrap"><canvas id="hslWheel" width="100" height="100"></canvas></div>
      <div class="swatches" id="swatches"></div>
    </div>

  </div>
</div>

<div class="toast" id="toast">Copied!</div>

<script>
// ===== State =====
let R = 255, G = 100, B = 80;
let baseColor = {r:255, g:100, b:80};
let harmony = 'complementary';
let modes = {animate:true, particles:false, beams:false};
let primaries = {r:true, g:true, b:false};
let cvdMode = 'normal';
let animT = 0;
let particles = [];
let isDragging = false;
let clickPos = null; // {x,y} in canvas CSS coords — for drawing the pick indicator

// ===== DOM =====
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
const rSlider = document.getElementById('rSlider');
const gSlider = document.getElementById('gSlider');
const bSlider = document.getElementById('bSlider');
const rVal = document.getElementById('rVal');
const gVal = document.getElementById('gVal');
const bVal = document.getElementById('bVal');
const selPreview = document.getElementById('selPreview');
const infoR = document.getElementById('infoR');
const infoG = document.getElementById('infoG');
const infoB = document.getElementById('infoB');
const hexCopy = document.getElementById('hexCopy');
const overlayHex = document.getElementById('overlayHex');
const overlayRgb = document.getElementById('overlayRgb');
const overlayHsl = document.getElementById('overlayHsl');
const overlaySwatch = document.getElementById('overlaySwatch');
const overlayName = document.getElementById('overlayName');
const recipeBox = document.getElementById('recipeBox');
const basePicker = document.getElementById('basePicker');
const swatchesEl = document.getElementById('swatches');
const cvdLabel = document.getElementById('cvdLabel');
const wheelCanvas = document.getElementById('hslWheel');
const wheelCtx = wheelCanvas.getContext('2d');
const toast = document.getElementById('toast');

// ===== Color Math =====
function clamp(v,lo=0,hi=255){return Math.max(lo,Math.min(hi,Math.round(v)))}
function toHex(r,g,b){return '#'+[r,g,b].map(v=>clamp(v).toString(16).padStart(2,'0')).join('').toUpperCase()}

function rgbToHsl(r,g,b){
  r/=255;g/=255;b/=255;
  const mx=Math.max(r,g,b),mn=Math.min(r,g,b),d=mx-mn;
  let h=0,s=0,l=(mx+mn)/2;
  if(d>0){
    s=l>0.5?d/(2-mx-mn):d/(mx+mn);
    if(mx===r)h=((g-b)/d+(g<b?6:0))/6;
    else if(mx===g)h=((b-r)/d+2)/6;
    else h=((r-g)/d+4)/6;
  }
  return [h*360,s*100,l*100];
}

function hslToRgb(h,s,l){
  h/=360;s/=100;l/=100;
  if(s===0)return [l*255,l*255,l*255];
  const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};
  const q=l<0.5?l*(1+s):l+s-l*s,p=2*l-q;
  return [hue2rgb(p,q,h+1/3)*255,hue2rgb(p,q,h)*255,hue2rgb(p,q,h-1/3)*255];
}

// CVD
const HPE=[[0.4002,0.7076,-0.0808],[-0.2263,1.1653,0.0457],[0,0,0.9182]];
const HPE_INV=[[1.8601,-1.1295,0.2199],[0.3612,0.6388,-0.0001],[0,0,1.0891]];
function matMul(m,v){return m.map(row=>row[0]*v[0]+row[1]*v[1]+row[2]*v[2])}
function linearize(c){c/=255;return c<=0.04045?c/12.92:Math.pow((c+0.055)/1.055,2.4)}
function delinearize(c){c=Math.max(0,Math.min(1,c));return c<=0.0031308?c*12.92*255:((1.055*Math.pow(c,1/2.4))-0.055)*255}
const CVD_MATRICES={
  protanopia:[[0,2.02344,-2.52581],[0,1,0],[0,0,1]],
  deuteranopia:[[1,0,0],[0.49421,0,1.24827],[0,0,1]],
  tritanopia:[[1,0,0],[0,1,0],[-0.395913,0.801109,0]]
};
function simulateCVD(r,g,b,type){
  if(type==='normal')return [r,g,b];
  if(type==='achromatopsia'){const y=clamp(0.299*r+0.587*g+0.114*b);return [y,y,y]}
  const lin=[linearize(r),linearize(g),linearize(b)];
  const lms=matMul(HPE,lin);
  const sim=matMul(CVD_MATRICES[type],lms);
  const rgb=matMul(HPE_INV,sim);
  return [clamp(delinearize(rgb[0])),clamp(delinearize(rgb[1])),clamp(delinearize(rgb[2]))];
}

// Harmony
function getHarmonyColors(h,s,l,type){
  const colors=[];
  const w=v=>((v%360)+360)%360;
  switch(type){
    case 'complementary':
      colors.push({role:'Base',h,s,l},{role:'Complement',h:w(h+180),s,l},{role:'Light',h,s:s*0.7,l:Math.min(l+20,95)},{role:'Dark',h,s:s*0.8,l:Math.max(l-25,5)});break;
    case 'analogous':
      colors.push({role:'Base',h,s,l},{role:'Analog +30',h:w(h+30),s,l},{role:'Analog -30',h:w(h-30),s,l},{role:'Accent',h:w(h+15),s:s*0.6,l:Math.min(l+15,90)});break;
    case 'triadic':
      colors.push({role:'Base',h,s,l},{role:'Triad +120',h:w(h+120),s,l},{role:'Triad -120',h:w(h-120),s,l},{role:'Neutral',h,s:s*0.2,l:Math.min(l+10,90)});break;
    case 'split':
      colors.push({role:'Base',h,s,l},{role:'Split +150',h:w(h+150),s,l},{role:'Split -150',h:w(h-150),s,l},{role:'Accent',h:w(h+180),s:s*0.5,l:Math.min(l+20,90)});break;
    case 'tetradic':
      colors.push({role:'Base',h,s,l},{role:'Rect +90',h:w(h+90),s,l},{role:'Rect +180',h:w(h+180),s,l},{role:'Rect +270',h:w(h+270),s,l});break;
    case 'monochromatic':
      colors.push({role:'Base',h,s,l},{role:'Lighter',h,s:s*0.7,l:Math.min(l+25,95)},{role:'Darker',h,s:Math.min(s*1.2,100),l:Math.max(l-25,5)},{role:'Muted',h,s:s*0.3,l});break;
  }
  return colors;
}

// ===== Color Recipe =====
function getRecipe(r,g,b){
  const max=Math.max(r,g,b);
  const parts=[];
  const describe=(v,name)=>{
    if(v===0)return null;
    const ratio=v/255;
    if(ratio>0.85)return 'Lots of '+name;
    if(ratio>0.55)return 'Good amount of '+name;
    if(ratio>0.25)return 'A little '+name;
    return 'Very little '+name;
  };
  const rd=describe(r,'red'),gd=describe(g,'green'),bd=describe(b,'blue');
  if(rd)parts.push(rd);
  if(gd)parts.push(gd);
  if(bd)parts.push(bd);
  if(parts.length===0)parts.push('Very little of any primary');

  // Name the result
  const [h,s,l]=rgbToHsl(r,g,b);
  let name='';
  if(l<8)name='Near black';
  else if(l>92)name='Near white';
  else if(s<10)name='Gray tone';
  else{
    if(h<15||h>=345)name='Red';
    else if(h<35)name='Orange';
    else if(h<65)name='Yellow';
    else if(h<160)name='Green';
    else if(h<200)name='Cyan';
    else if(h<260)name='Blue';
    else if(h<290)name='Purple';
    else if(h<345)name='Pink/Magenta';
    if(l<35)name='Dark '+name.toLowerCase();
    else if(l>70)name='Light '+name.toLowerCase();
    if(s<40)name='Muted '+name.toLowerCase();
  }
  return {mix:parts.join(' + '),result:name};
}

// ===== Canvas: Starburst Color Wheel =====
function resizeCanvas(){
  const area=canvas.parentElement;
  canvas.width=area.clientWidth*window.devicePixelRatio;
  canvas.height=area.clientHeight*window.devicePixelRatio;
  canvas.style.width=area.clientWidth+'px';
  canvas.style.height=area.clientHeight+'px';
  ctx.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0);
}

function drawStarburst(){
  const w=canvas.width/window.devicePixelRatio;
  const h=canvas.height/window.devicePixelRatio;
  const cx=w/2, cy=h/2;
  const maxR=Math.min(w,h)*0.46;

  ctx.globalCompositeOperation='source-over';
  ctx.fillStyle='#000';
  ctx.fillRect(0,0,w,h);

  const numPetals=60;
  const petalAngle=Math.PI*2/numPetals;
  const spin=modes.animate?animT*0.003:0;

  ctx.globalCompositeOperation='screen';

  // Each primary always renders at full 255 brightness in its sector
  // Sliders control the "selected" color, but the wheel stays vivid
  const layers=[
    {center:0,            cr:primaries.r?255:0, cg:0, cb:0},
    {center:Math.PI*2/3,  cr:0, cg:primaries.g?255:0, cb:0},
    {center:Math.PI*4/3,  cr:0, cg:0, cb:primaries.b?255:0}
  ];

  layers.forEach(layer=>{
    const maxC=Math.max(layer.cr,layer.cg,layer.cb);
    if(maxC===0)return;

    for(let i=0;i<numPetals;i++){
      const angle=i*petalAngle+spin;
      const nextAngle=angle+petalAngle*0.85;

      // Angular distance from this petal to the layer's center sector
      let diff=angle+petalAngle*0.4-layer.center-spin;
      diff=Math.atan2(Math.sin(diff),Math.cos(diff)); // normalize to [-PI, PI]
      // Smooth falloff: full brightness in sector, fades in neighboring sectors
      const falloff=Math.pow(Math.max(0,Math.cos(diff*0.75)),1.5);
      if(falloff<0.01)continue;

      const brightness=falloff;
      const petalLen=maxR*(0.82+0.18*Math.sin(i*0.7+animT*0.015));

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.lineTo(cx+Math.cos(angle)*petalLen,cy+Math.sin(angle)*petalLen);
      ctx.lineTo(cx+Math.cos(nextAngle)*petalLen,cy+Math.sin(nextAngle)*petalLen);
      ctx.closePath();

      // Solid bright fill — apply CVD filter if active
      let pr=clamp(layer.cr*brightness);
      let pg=clamp(layer.cg*brightness);
      let pb=clamp(layer.cb*brightness);
      if(cvdMode!=='normal'){
        [pr,pg,pb]=simulateCVD(pr,pg,pb,cvdMode);
      }
      ctx.fillStyle=`rgb(${pr},${pg},${pb})`;
      ctx.fill();
    }
  });

  // Beams mode
  if(modes.beams){
    ctx.globalCompositeOperation='screen';
    const beamCount=8;
    for(let i=0;i<beamCount;i++){
      const ba=animT*0.012+i*Math.PI*2/beamCount;
      const bLen=maxR*1.4;
      const bx=cx+Math.cos(ba)*bLen;
      const by=cy+Math.sin(ba)*bLen;
      const grad=ctx.createLinearGradient(cx,cy,bx,by);
      grad.addColorStop(0,`rgba(${clamp(R)},${clamp(G)},${clamp(B)},0.35)`);
      grad.addColorStop(1,`rgba(${clamp(R)},${clamp(G)},${clamp(B)},0)`);
      ctx.strokeStyle=grad;
      ctx.lineWidth=maxR*0.08;
      ctx.lineCap='round';
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.lineTo(bx,by);
      ctx.stroke();
    }
  }

  // Particles
  if(modes.particles){
    ctx.globalCompositeOperation='screen';
    if(Math.random()<0.5){
      const a=Math.random()*Math.PI*2;
      const spd=1+Math.random()*2;
      particles.push({x:cx,y:cy,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,life:1,
        r:50+R*Math.random()*0.8,g:50+G*Math.random()*0.8,b:50+B*Math.random()*0.8,size:Math.random()*4+2});
    }
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.x+=p.vx;p.y+=p.vy;p.vx*=1.008;p.vy*=1.008;p.life-=0.005;
      if(p.life<=0){particles.splice(i,1);continue}
      ctx.fillStyle=`rgba(${clamp(p.r)},${clamp(p.g)},${clamp(p.b)},${p.life})`;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);
      ctx.fill();
    }
    if(particles.length>500)particles.splice(0,80);
  }

  // Bright center glow with pulse
  ctx.globalCompositeOperation='screen';
  const pulse=0.5+0.5*Math.sin(animT*0.04);
  const glowR=maxR*0.18*(0.7+pulse*0.3);
  const glow=ctx.createRadialGradient(cx,cy,0,cx,cy,glowR);
  glow.addColorStop(0,`rgba(255,255,255,${0.4+pulse*0.3})`);
  glow.addColorStop(0.3,`rgba(${clamp(R)},${clamp(G)},${clamp(B)},${0.3+pulse*0.2})`);
  glow.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=glow;
  ctx.beginPath();
  ctx.arc(cx,cy,glowR,0,Math.PI*2);
  ctx.fill();

  ctx.globalCompositeOperation='source-over';

  // Draw pick indicator circle at last click/slider position
  if(clickPos){
    const ix=clickPos.x, iy=clickPos.y;
    const hex=toHex(R,G,B);
    const [,,ll]=rgbToHsl(R,G,B);
    const ringPulse=0.5+0.5*Math.sin(animT*0.08);
    // Pulsing outer glow ring so you can see it move
    ctx.beginPath();
    ctx.arc(ix,iy,32+ringPulse*4,0,Math.PI*2);
    ctx.lineWidth=2;
    ctx.strokeStyle=`rgba(255,255,255,${0.15+ringPulse*0.15})`;
    ctx.stroke();
    // Filled color circle
    ctx.beginPath();
    ctx.arc(ix,iy,26,0,Math.PI*2);
    ctx.fillStyle=hex;
    ctx.fill();
    ctx.lineWidth=3;
    ctx.strokeStyle=ll<30?'rgba(255,255,255,0.9)':'rgba(0,0,0,0.6)';
    ctx.stroke();
    // Inner bright border
    ctx.beginPath();
    ctx.arc(ix,iy,24,0,Math.PI*2);
    ctx.lineWidth=1.5;
    ctx.strokeStyle=ll<30?'rgba(255,255,255,0.4)':'rgba(255,255,255,0.7)';
    ctx.stroke();
  }
}

// ===== HSL Wheel =====
function drawWheel(baseH){
  const s=100,cx=50,cy=50,r=44;
  wheelCtx.clearRect(0,0,s,s);
  for(let a=0;a<360;a++){
    const s1=(a-1)*Math.PI/180;
    const s2=(a+1)*Math.PI/180;
    wheelCtx.beginPath();
    wheelCtx.moveTo(cx,cy);
    wheelCtx.arc(cx,cy,r,s1,s2);
    wheelCtx.closePath();
    const [cr,cg,cb]=hslToRgb(a,80,50);
    wheelCtx.fillStyle=`rgb(${cr},${cg},${cb})`;
    wheelCtx.fill();
  }
  const cg=wheelCtx.createRadialGradient(cx,cy,r*0.4,cx,cy,r);
  cg.addColorStop(0,'#0d0d18');
  cg.addColorStop(1,'transparent');
  wheelCtx.fillStyle=cg;
  wheelCtx.beginPath();
  wheelCtx.arc(cx,cy,r,0,Math.PI*2);
  wheelCtx.fill();
  const da=baseH*Math.PI/180;
  const dx=cx+Math.cos(da)*r*0.7;
  const dy=cy+Math.sin(da)*r*0.7;
  wheelCtx.beginPath();
  wheelCtx.arc(dx,dy,4,0,Math.PI*2);
  wheelCtx.fillStyle='#fff';
  wheelCtx.fill();
  wheelCtx.strokeStyle='#000';
  wheelCtx.lineWidth=1.5;
  wheelCtx.stroke();
}

// ===== Updates =====
function updateDisplay(){
  const hex=toHex(R,G,B);
  const [h,s,l]=rgbToHsl(R,G,B);

  // Sidebar
  selPreview.style.background=hex;
  // Show a full-saturation reference strip so dark colors still show their hue
  const [br,bg,bb]=hslToRgb(h,Math.max(s,60),Math.max(l,45));
  document.getElementById('selBright').style.background=toHex(br,bg,bb);
  infoR.textContent=R;
  infoG.textContent=G;
  infoB.textContent=B;
  hexCopy.textContent=hex;
  rVal.textContent=R;
  gVal.textContent=G;
  bVal.textContent=B;

  // Canvas overlay — big swatch + readable text
  overlaySwatch.style.background=hex;
  overlaySwatch.style.borderColor=l<30?'rgba(255,255,255,0.35)':'rgba(255,255,255,0.15)';
  overlayHex.textContent=hex;
  overlayHex.style.color=l<25?'#fff':hex;
  const recipe=getRecipe(R,G,B);
  overlayName.textContent=recipe.result||'Black';
  overlayRgb.textContent=`${R}, ${G}, ${B}`;
  overlayHsl.textContent=`${Math.round(h)}\u00B0, ${Math.round(s)}%, ${Math.round(l)}%`;

  // Recipe
  recipeBox.innerHTML=`<div class="recipe-line">${recipe.mix}</div>&rarr; ${recipe.result}`;
}

function updateCVD(){
  // Update the small dot previews on each CVD button to show base color through that filter
  const dotMap={normal:'cvdDotNormal',protanopia:'cvdDotProt',deuteranopia:'cvdDotDeut',tritanopia:'cvdDotTrit',achromatopsia:'cvdDotAchro'};
  Object.keys(dotMap).forEach(type=>{
    const el=document.getElementById(dotMap[type]);
    if(!el)return;
    const [sr,sg,sb]=simulateCVD(baseColor.r,baseColor.g,baseColor.b,type);
    el.style.background=toHex(sr,sg,sb);
  });
}

function updatePalette(){
  const [h,s,l]=rgbToHsl(baseColor.r,baseColor.g,baseColor.b);
  drawWheel(h);
  const colors=getHarmonyColors(h,s,l,harmony);
  swatchesEl.innerHTML='';
  colors.forEach(c=>{
    const [cr,cg,cb]=hslToRgb(c.h,c.s,c.l);
    const hex=toHex(cr,cg,cb);
    const card=document.createElement('div');
    card.className='swatch-card';
    card.innerHTML=`<div class="swatch-color" style="background:${hex}"></div><div class="swatch-role">${c.role}</div><div class="swatch-hex">${hex}</div><div class="swatch-rgb">${clamp(cr)}, ${clamp(cg)}, ${clamp(cb)}</div>`;
    card.addEventListener('click',()=>copyHex(hex));
    swatchesEl.appendChild(card);
  });
}

function setBaseColor(r,g,b){
  baseColor={r:clamp(r),g:clamp(g),b:clamp(b)};
  basePicker.value=toHex(baseColor.r,baseColor.g,baseColor.b);
  updatePalette();
  updateCVD();
}

// ===== Events =====
rSlider.addEventListener('input',()=>{R=+rSlider.value;updateClickPosFromRGB();updateDisplay()});
gSlider.addEventListener('input',()=>{G=+gSlider.value;updateClickPosFromRGB();updateDisplay()});
bSlider.addEventListener('input',()=>{B=+bSlider.value;updateClickPosFromRGB();updateDisplay()});

// Primary toggle buttons
document.querySelectorAll('.primary-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const p=btn.dataset.primary;
    primaries[p]=!primaries[p];
    btn.classList.toggle('active',primaries[p]);
    // Sync slider if primary is turned off
    if(!primaries[p]){
      if(p==='r'){R=0;rSlider.value=0}
      if(p==='g'){G=0;gSlider.value=0}
      if(p==='b'){B=0;bSlider.value=0}
    } else {
      if(p==='r'){R=255;rSlider.value=255}
      if(p==='g'){G=255;gSlider.value=255}
      if(p==='b'){B=255;bSlider.value=255}
    }
    updateClickPosFromRGB();
    updateDisplay();
  });
});

// Mode buttons
document.querySelectorAll('.mode-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const mode=btn.dataset.mode;
    modes[mode]=!modes[mode];
    btn.classList.toggle('active',modes[mode]);
    if(!modes.particles)particles=[];
  });
});

// Palette controls
document.getElementById('useMixerBtn').addEventListener('click',()=>setBaseColor(R,G,B));
basePicker.addEventListener('input',()=>{
  const hex=basePicker.value;
  setBaseColor(parseInt(hex.slice(1,3),16),parseInt(hex.slice(3,5),16),parseInt(hex.slice(5,7),16));
});
document.querySelectorAll('.harmony-tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.harmony-tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    harmony=tab.dataset.harmony;
    updatePalette();
  });
});

// CVD toggle buttons
const cvdBanner=document.getElementById('cvdBanner');
const cvdNames={normal:'Normal vision',protanopia:'Protanopia (red-blind)',deuteranopia:'Deuteranopia (green-blind)',tritanopia:'Tritanopia (blue-blind)',achromatopsia:'Achromatopsia (grayscale)'};
document.querySelectorAll('.cvd-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.cvd-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    cvdMode=btn.dataset.cvd;
    cvdLabel.textContent='Viewing: '+cvdNames[cvdMode];
    // Show/hide canvas banner
    if(cvdMode!=='normal'){
      cvdBanner.textContent='Simulating: '+cvdNames[cvdMode];
      cvdBanner.classList.add('visible');
    } else {
      cvdBanner.classList.remove('visible');
    }
  });
});

// Reverse mapping: RGB slider values → position on starburst wheel
function updateClickPosFromRGB(){
  const rect=canvas.getBoundingClientRect();
  const cx=rect.width/2, cy=rect.height/2;
  const maxDist=Math.min(rect.width,rect.height)*0.46*0.85;

  const [h,s,l]=rgbToHsl(R,G,B);

  // If the color is very dark or gray, place near center
  if(s<5||l<5){
    clickPos={x:cx,y:cy};
    return;
  }

  // HSL hue maps directly: Red=0°, Green=120°, Blue=240°
  const angle=h*Math.PI/180;

  // Distance: min(R,G,B)/255 is the white component → center; pure colors → edge
  const sat=1-Math.min(R,G,B)/255;

  clickPos={
    x:cx+Math.cos(angle)*maxDist*Math.max(0.08,sat),
    y:cy+Math.sin(angle)*maxDist*Math.max(0.08,sat)
  };
}

// Canvas click — derive color from angle on the wheel (additive RGB mixing)
function canvasColorFromPos(e){
  const rect=canvas.getBoundingClientRect();
  const px=e.clientX-rect.left-rect.width/2;
  const py=e.clientY-rect.top-rect.height/2;
  const angle=Math.atan2(py,px); // -PI to PI
  const dist=Math.sqrt(px*px+py*py)/Math.min(rect.width,rect.height)*2;
  const sat=Math.min(dist,1); // distance from center = saturation

  // Red at 0°, Green at 120°, Blue at 240° — same as the starburst sectors
  // Each channel peaks in its sector and falls off smoothly
  function chanBrightness(centerAngle){
    let diff=angle-centerAngle;
    diff=Math.atan2(Math.sin(diff),Math.cos(diff));
    return Math.pow(Math.max(0,Math.cos(diff*0.75)),1.5);
  }
  const rr=chanBrightness(0);
  const gg=chanBrightness(Math.PI*2/3);
  const bb=chanBrightness(Math.PI*4/3);
  // Blend: at center (sat=0) → white, at edge (sat=1) → pure additive mix
  const r=clamp(255*(1-sat)+255*rr*sat);
  const g=clamp(255*(1-sat)+255*gg*sat);
  const b=clamp(255*(1-sat)+255*bb*sat);
  return [r,g,b];
}
function setClickPos(e){
  const rect=canvas.getBoundingClientRect();
  clickPos={x:e.clientX-rect.left, y:e.clientY-rect.top};
}
function pickColor(e){
  setClickPos(e);
  const[r,g,b]=canvasColorFromPos(e);
  R=r;G=g;B=b;
  rSlider.value=R;gSlider.value=G;bSlider.value=B;
  updateDisplay();
}
canvas.addEventListener('mousedown',e=>{isDragging=true;pickColor(e)});
canvas.addEventListener('mousemove',e=>{if(!isDragging)return;pickColor(e)});
canvas.addEventListener('mouseup',()=>{if(isDragging){isDragging=false;setBaseColor(R,G,B)}});
canvas.addEventListener('click',e=>{pickColor(e);setBaseColor(R,G,B)});
canvas.addEventListener('mouseleave',()=>{isDragging=false});

// Touch
canvas.addEventListener('touchstart',e=>{e.preventDefault();pickColor(e.touches[0])},{passive:false});
canvas.addEventListener('touchmove',e=>{e.preventDefault();pickColor(e.touches[0])},{passive:false});
canvas.addEventListener('touchend',()=>setBaseColor(R,G,B));

// Copy hex
hexCopy.addEventListener('click',()=>copyHex(hexCopy.textContent));
function copyHex(text){
  navigator.clipboard.writeText(text).then(()=>{
    toast.textContent=`Copied ${text}`;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'),1500);
  });
}

// Resize — also update the pick indicator position since it's based on canvas size
window.addEventListener('resize',()=>{resizeCanvas();updateClickPosFromRGB()});

// ===== Animation Loop =====
function animate(){
  animT++;
  drawStarburst();
  requestAnimationFrame(animate);
}

// ===== Init =====
resizeCanvas();
updateClickPosFromRGB(); // Show the pick indicator on load
updateDisplay();
setBaseColor(R,G,B);
animate();
</script>
</body>
</html>
